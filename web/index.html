<!DOCTYPE html>
<html>
<head>
  <title>McD Topup</title>
</head>
<body>

  <h2>Topup Pulsa</h2>

  <label>Nomor HP:</label><br>
  <input type="text" id="phone"><br><br>

  <label>Provider:</label><br>
  <select id="provider">
    <option value="telkomsel">Telkomsel</option>
    <option value="xl">XL</option>
  </select><br><br>

  <label>Nominal:</label><br>
  <select id="nominal">
  <option value="5k">5K</option>
  <option value="10k">10K</option>
  <option value="20k">20K</option>
</select>
<br><br>

  <button onclick="buatOrder()">Beli Sekarang</button>
  <button onclick="bukaStatusLagi()">Lihat Status Transaksi</button>


  <div id="popup" style="
  display:none;
  position:fixed;
  top:20%;
  left:50%;
  transform:translate(-50%, -20%);
  background:white;
  padding:20px;
  border:1px solid black;
  z-index:999;
">
  <h3>Status Transaksi</h3>
  <p id="popupStatus">Menunggu...</p>
  <p id="popupLink"></p>
  <button onclick="tutupPopup()">Tutup</button>
</div>

<script>
  let currentOrderId = null;

window.onload = function() {
  const last = localStorage.getItem("last_order_id");
  if (last) {
    currentOrderId = last;

    // langsung ambil status terakhir
    fetch("https://mcd-topup-bot-production.up.railway.app/topup/" + currentOrderId)
      .then(res => res.json())
      .then(data => {
        document.getElementById("popupStatus").innerText =
          "Status: " + data.status;

        document.getElementById("popupLink").innerHTML =
          "<a href='" + data.invoice_url + "' target='_blank'>Klik di sini untuk bayar</a>";
      });
  }
};



async function buatOrder() {
  const phone = document.getElementById("phone").value;
  const provider = document.getElementById("provider").value;
  const nominal = document.getElementById("nominal").value;

  const response = await fetch("https://mcd-topup-bot-production.up.railway.app/topup", {
    method: "POST",
    headers: {
      "Content-Type": "application/json"
    },
    body: JSON.stringify({
      phone: phone,
      provider: provider,
      nominal: nominal,
      method: "QRIS"
    })
  });

  const data = await response.json();

  currentOrderId = data.id;
    localStorage.setItem("last_order_id", data.id);


    
  document.getElementById("popup").style.display = "block";
  document.getElementById("popupStatus").innerText = "Status: pending";
  document.getElementById("popupLink").innerHTML =
    "<a href='" + data.invoice_url + "' target='_blank'>Klik di sini untuk bayar</a>";

  cekStatus();
}

async function cekStatus() {
  if (!currentOrderId) return;

  const response = await fetch("https://mcd-topup-bot-production.up.railway.app/topup/" + currentOrderId);
  const data = await response.json();

  document.getElementById("popupStatus").innerText =
    "Status: " + data.status;

  if (data.status.toLowerCase() !== "paid") {
    setTimeout(cekStatus, 5000);
  }
}

function tutupPopup() {
  document.getElementById("popup").style.display = "none";
}

function bukaStatusLagi() {
  if (!currentOrderId) {
    alert("Belum ada transaksi.");
    return;
  }
  document.getElementById("popup").style.display = "block";
    }
</script>


</body>
</html>
